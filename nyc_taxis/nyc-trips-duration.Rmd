---
title: "NYC Taxi Trips Duration"
author: "Daniel Vargas"
date: August 02, 2017
output: 
    html_document:
        theme: cosmo
        code_folding: hide
---

## The Data

```{r libraries, message = FALSE, warning = FALSE}
library(data.table)
library(ggplot2)
library(lubridate)
library(leaflet)
library(dplyr)
library(randomForest)
library(geojsonio)
```

Just reading the datastes.

```{r sets, message = FALSE, warning = FALSE}
train <- fread("../input/nyc-taxi-trip-duration/train.csv", showProgress = FALSE)
test <- fread("../input/nyc-taxi-trip-duration/test.csv", showProgress = FALSE)
```

WOW! An unicorn of dataset: `0` N/As.

```{r quick, message = FALSE, warning = FALSE}
dim(train); dim(test)
str(train); str(test)
sum(is.na(train)); sum(is.na(test))
```

Cleaning up the data

```{r cleanup}
train <- subset(train, trip_duration <= 85000)

train$pickup_datetime <- as.Date(train$pickup_datetime)

train$pickup_weekdays <- weekdays(train$pickup_datetime)
train$pickup_weekdays <- as.factor(train$pickup_weekdays)
train$pickup_hour <- hour(train$pickup_datetime)

test$pickup_datetime <- as.Date(test$pickup_datetime)

test$pickup_weekdays <- weekdays(test$pickup_datetime)
test$pickup_weekdays <- as.factor(test$pickup_weekdays)
test$pickup_hour <- hour(test$pickup_datetime)
```

I am very visual, so let's see how the pick-ups look on a map. `1.5mm` coordinates seems too much for Leaflet, so let's sample that.

```{r map}
set.seed(20170803)
sample <- sample_n(train, 50000)
map <- sample_n(sample, 1000)

map %>% 
        leaflet() %>% 
        addTiles() %>% 
        ##  addPolygons(data = bound, stroke = FALSE, smoothFactor = 0.3, 
        ##  fillOpacity = 0.2, fillColor = "green") %>%
        addCircleMarkers(~pickup_longitude, ~pickup_latitude, 
                         radius = 1, 
                         color = "black",
                         fillOpacity = 1)
```

Let us look at the trip durations. I won't do too many graphs, since there a not so many variables.

```{r graph}
ggplot(data =train, aes(x = trip_duration)) + 
        geom_histogram(bins = 50000, fill = "black") + 
        theme_bw() + theme(axis.title = element_text(size = 12), axis.text = element_text(size = 12))+ 
        coord_cartesian(x = c(0, 6000))

ggplot(data = train, aes(x = pickup_datetime, y = trip_duration)) + 
        geom_point(aes(colour = factor(vendor_id)))
```

It seems that Vendor `2` brings in the most variation into the trips duration.

Let me just submit for now.

```{r}
trip <- randomForest(trip_duration ~ 
                             vendor_id + 
                             passenger_count + 
                             pickup_longitude + 
                             pickup_latitude + 
                             pickup_hour + 
                             pickup_weekdays, 
                     data = sample, ntree = 100)

prediction <- predict(trip, test, type = "response")

head(prediction, 10)

submit <- data.frame(id = test$id, trip_duration = prediction)

write.csv(submit, "submission.csv", row.names = FALSE)
```

## Next steps:

* I suspect there are pick-ups outside NYC, I will be identifying them
* <del>I will get rid of the 4 outliers-outliers for further analysis (trip_duration > 87000)</del>
* It is a lot of data, too much for my PC. I might try ,<del>`h2o`</del> or `AWS`
* Improve model locally and then add the weather data, maybe the flights data